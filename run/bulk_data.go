package run

import (
	"context"
	"database/sql"
	"encoding/json"
	"fmt"
	"os"
	"strings"
	"time"

	"google.golang.org/appengine"
	"google.golang.org/appengine/log"
)

var bogusData = `
{"EntityData":[{"Data":[{"Data":[{"Time":"2016-10-01T00:00:00Z","Data":395.0123125139915},{"Time":"2016-10-02T00:00:00Z","Data":376.90746268656716},{"Time":"2016-10-03T00:00:00Z","Data":473.96568468760114},{"Time":"2016-10-04T00:00:00Z","Data":494.7239036155755},{"Time":"2016-10-05T00:00:00Z","Data":490.0262277725643},{"Time":"2016-10-06T00:00:00Z","Data":492.4416275088333},{"Time":"2016-10-07T00:00:00Z","Data":463.11853293719906},{"Time":"2016-10-08T00:00:00Z","Data":396.31900666749567},{"Time":"2016-10-09T00:00:00Z","Data":381.38440437392256},{"Time":"2016-10-10T00:00:00Z","Data":450.25025318870996},{"Time":"2016-10-11T00:00:00Z","Data":483.64160700079555},{"Time":"2016-10-12T00:00:00Z","Data":472.7365285267167},{"Time":"2016-10-13T00:00:00Z","Data":485.7227095157367},{"Time":"2016-10-14T00:00:00Z","Data":452.4882821504495},{"Time":"2016-10-15T00:00:00Z","Data":387.61015538607114},{"Time":"2016-10-16T00:00:00Z","Data":368.8052658104125},{"Time":"2016-10-17T00:00:00Z","Data":462.1624396755314},{"Time":"2016-10-18T00:00:00Z","Data":469.9358151476252},{"Time":"2016-10-19T00:00:00Z","Data":480.65096952908584},{"Time":"2016-10-20T00:00:00Z","Data":476.52441311032777},{"Time":"2016-10-21T00:00:00Z","Data":444.5113194796418},{"Time":"2016-10-22T00:00:00Z","Data":381.1747851002865},{"Time":"2016-10-23T00:00:00Z","Data":362.7310300845015},{"Time":"2016-10-24T00:00:00Z","Data":452.82832696671977},{"Time":"2016-10-25T00:00:00Z","Data":478.6187512547681},{"Time":"2016-10-26T00:00:00Z","Data":465.3765690376569},{"Time":"2016-10-27T00:00:00Z","Data":468.1551507698614},{"Time":"2016-10-28T00:00:00Z","Data":444.53598664892155},{"Time":"2016-10-29T00:00:00Z","Data":386.4609380919906},{"Time":"2016-10-30T00:00:00Z","Data":365.38299587348564},{"Time":"2016-10-31T00:00:00Z","Data":513.5823767500498},{"Time":"2016-11-01T00:00:00Z","Data":460.5119981673444},{"Time":"2016-11-02T00:00:00Z","Data":466.08369280492093},{"Time":"2016-11-03T00:00:00Z","Data":463.2084360519896},{"Time":"2016-11-04T00:00:00Z","Data":434.021075851486},{"Time":"2016-11-05T00:00:00Z","Data":365.0759280354739},{"Time":"2016-11-06T00:00:00Z","Data":359.404492556157},{"Time":"2016-11-07T00:00:00Z","Data":447.9640444599941},{"Time":"2016-11-08T00:00:00Z","Data":461.8786554489905},{"Time":"2016-11-09T00:00:00Z","Data":466.69243997707065},{"Time":"2016-11-10T00:00:00Z","Data":460.54179960936074},{"Time":"2016-11-11T00:00:00Z","Data":391.2371134020619},{"Time":"2016-11-12T00:00:00Z","Data":359.2785996569273},{"Time":"2016-11-13T00:00:00Z","Data":349.2803853609822},{"Time":"2016-11-14T00:00:00Z","Data":439.4270488220947},{"Time":"2016-11-15T00:00:00Z","Data":450.6968760727772},{"Time":"2016-11-16T00:00:00Z","Data":455.0762162230768},{"Time":"2016-11-17T00:00:00Z","Data":451.6884066804828},{"Time":"2016-11-18T00:00:00Z","Data":421.99308688265273},{"Time":"2016-11-19T00:00:00Z","Data":339.51556597862475},{"Time":"2016-11-20T00:00:00Z","Data":318.9898064368343},{"Time":"2016-11-21T00:00:00Z","Data":399.6641761610151},{"Time":"2016-11-22T00:00:00Z","Data":391.4767643517547},{"Time":"2016-11-23T00:00:00Z","Data":351.65460529435757},{"Time":"2016-11-24T00:00:00Z","Data":134.0658779687839},{"Time":"2016-11-25T00:00:00Z","Data":229.64070046650144},{"Time":"2016-11-26T00:00:00Z","Data":303.07520993980194},{"Time":"2016-11-27T00:00:00Z","Data":310.7854558832546},{"Time":"2016-11-28T00:00:00Z","Data":377.04660479626534},{"Time":"2016-11-29T00:00:00Z","Data":418.6078497568051},{"Time":"2016-11-30T00:00:00Z","Data":437.8185204293498},{"Time":"2016-12-01T00:00:00Z","Data":431.86872503508584},{"Time":"2016-12-02T00:00:00Z","Data":410.3696491289077},{"Time":"2016-12-03T00:00:00Z","Data":342.20758462259033},{"Time":"2016-12-04T00:00:00Z","Data":331.7200607839464},{"Time":"2016-12-05T00:00:00Z","Data":413.56220145837244},{"Time":"2016-12-06T00:00:00Z","Data":422.067715951014},{"Time":"2016-12-07T00:00:00Z","Data":415.56048538628454},{"Time":"2016-12-08T00:00:00Z","Data":419.9567982719309},{"Time":"2016-12-09T00:00:00Z","Data":382.64315051944914},{"Time":"2016-12-10T00:00:00Z","Data":316.08875485312046},{"Time":"2016-12-11T00:00:00Z","Data":312.9398709225243},{"Time":"2016-12-12T00:00:00Z","Data":385.27363391249133},{"Time":"2016-12-13T00:00:00Z","Data":397.7460753057024},{"Time":"2016-12-14T00:00:00Z","Data":395.67140378501443},{"Time":"2016-12-15T00:00:00Z","Data":391.6157674200075},{"Time":"2016-12-16T00:00:00Z","Data":360.84713961243665},{"Time":"2016-12-17T00:00:00Z","Data":294.10729514965277},{"Time":"2016-12-18T00:00:00Z","Data":286.4878782090147},{"Time":"2016-12-19T00:00:00Z","Data":341.29188096685675},{"Time":"2016-12-20T00:00:00Z","Data":336.02846054333764},{"Time":"2016-12-21T00:00:00Z","Data":336.064202038643},{"Time":"2016-12-22T00:00:00Z","Data":321.6928527648633},{"Time":"2016-12-23T00:00:00Z","Data":283.4173169397334},{"Time":"2016-12-24T00:00:00Z","Data":241.89753190319976},{"Time":"2016-12-25T00:00:00Z","Data":570.4083007680906},{"Time":"2016-12-26T00:00:00Z","Data":283.282709147898},{"Time":"2016-12-27T00:00:00Z","Data":359.1521141855856},{"Time":"2016-12-28T00:00:00Z","Data":373.4492764038484},{"Time":"2016-12-29T00:00:00Z","Data":381.79420008426916},{"Time":"2016-12-30T00:00:00Z","Data":356.857627357053},{"Time":"2016-12-31T00:00:00Z","Data":307.824839661682},{"Time":"2017-01-01T00:00:00Z","Data":301.3488365775139},{"Time":"2017-01-02T00:00:00Z","Data":319.5022557309528},{"Time":"2017-01-03T00:00:00Z","Data":409.91968168975336},{"Time":"2017-01-04T00:00:00Z","Data":411.9234603321257},{"Time":"2017-01-05T00:00:00Z","Data":427.9390000643459},{"Time":"2017-01-06T00:00:00Z","Data":408.8347630079519},{"Time":"2017-01-07T00:00:00Z","Data":324.8251286788967},{"Time":"2017-01-08T00:00:00Z","Data":318.5466377440347},{"Time":"2017-01-09T00:00:00Z","Data":423.21922235823234},{"Time":"2017-01-10T00:00:00Z","Data":431.60385626643296},{"Time":"2017-01-11T00:00:00Z","Data":434.33968336489784},{"Time":"2017-01-12T00:00:00Z","Data":435.3442037724927},{"Time":"2017-01-13T00:00:00Z","Data":410.2475219696828},{"Time":"2017-01-14T00:00:00Z","Data":328.8792333789655},{"Time":"2017-01-15T00:00:00Z","Data":329.0744925191322},{"Time":"2017-01-16T00:00:00Z","Data":374.2086508207286},{"Time":"2017-01-17T00:00:00Z","Data":439.41678609259145},{"Time":"2017-01-18T00:00:00Z","Data":439.85812563974383},{"Time":"2017-01-19T00:00:00Z","Data":443.9417992575705},{"Time":"2017-01-20T00:00:00Z","Data":422.1496659152709},{"Time":"2017-01-21T00:00:00Z","Data":338.7833949856145},{"Time":"2017-01-22T00:00:00Z","Data":322.16828890187804},{"Time":"2017-01-23T00:00:00Z","Data":411.81502365448733},{"Time":"2017-01-24T00:00:00Z","Data":445.0674726265277},{"Time":"2017-01-25T00:00:00Z","Data":446.90716396616733},{"Time":"2017-01-26T00:00:00Z","Data":451.4104619701373},{"Time":"2017-01-27T00:00:00Z","Data":423.30078759976084},{"Time":"2017-01-28T00:00:00Z","Data":339.09183113579303},{"Time":"2017-01-29T00:00:00Z","Data":332.481500411102},{"Time":"2017-01-30T00:00:00Z","Data":434.48275862068965},{"Time":"2017-01-31T00:00:00Z","Data":443.2687286912185},{"Time":"2017-02-01T00:00:00Z","Data":439.0753117090638},{"Time":"2017-02-02T00:00:00Z","Data":440.3092992960692},{"Time":"2017-02-03T00:00:00Z","Data":414.0810740614948},{"Time":"2017-02-04T00:00:00Z","Data":335.95379941138674},{"Time":"2017-02-05T00:00:00Z","Data":327.9142847203702},{"Time":"2017-02-06T00:00:00Z","Data":437.2830314944163},{"Time":"2017-02-07T00:00:00Z","Data":454.35516542876434},{"Time":"2017-02-08T00:00:00Z","Data":441.7689022734566},{"Time":"2017-02-09T00:00:00Z","Data":439.7937187917815},{"Time":"2017-02-10T00:00:00Z","Data":418.07369333293485},{"Time":"2017-02-11T00:00:00Z","Data":342.3942668419534},{"Time":"2017-02-12T00:00:00Z","Data":328.94406685358325},{"Time":"2017-02-13T00:00:00Z","Data":409.1503267973856},{"Time":"2017-02-14T00:00:00Z","Data":404.1961631413478},{"Time":"2017-02-15T00:00:00Z","Data":442.8508523620809},{"Time":"2017-02-16T00:00:00Z","Data":446.87378262563305},{"Time":"2017-02-17T00:00:00Z","Data":424.3325206636142},{"Time":"2017-02-18T00:00:00Z","Data":348.70446743683124},{"Time":"2017-02-19T00:00:00Z","Data":349.843729454722},{"Time":"2017-02-20T00:00:00Z","Data":391.14869657740735},{"Time":"2017-02-21T00:00:00Z","Data":444.93774239640743},{"Time":"2017-02-22T00:00:00Z","Data":442.30674665617624},{"Time":"2017-02-23T00:00:00Z","Data":441.88402421984165},{"Time":"2017-02-24T00:00:00Z","Data":426.0824712726022},{"Time":"2017-02-25T00:00:00Z","Data":338.54205134157024},{"Time":"2017-02-26T00:00:00Z","Data":326.38429857121065},{"Time":"2017-02-27T00:00:00Z","Data":430.2020347128809},{"Time":"2017-02-28T00:00:00Z","Data":445.59385587345224},{"Time":"2017-03-01T00:00:00Z","Data":445.97561988866335},{"Time":"2017-03-02T00:00:00Z","Data":441.71410427959086},{"Time":"2017-03-03T00:00:00Z","Data":421.8463461361145},{"Time":"2017-03-04T00:00:00Z","Data":343.1920634664168},{"Time":"2017-03-05T00:00:00Z","Data":327.19118853097194},{"Time":"2017-03-06T00:00:00Z","Data":431.7580056951591},{"Time":"2017-03-07T00:00:00Z","Data":446.7637706431429},{"Time":"2017-03-08T00:00:00Z","Data":451.6049168760754},{"Time":"2017-03-09T00:00:00Z","Data":453.4051648415998},{"Time":"2017-03-10T00:00:00Z","Data":421.1643045484509},{"Time":"2017-03-11T00:00:00Z","Data":346.63646936402034},{"Time":"2017-03-12T00:00:00Z","Data":329.2563893149539},{"Time":"2017-03-13T00:00:00Z","Data":423.29744768356113},{"Time":"2017-03-14T00:00:00Z","Data":436.75315464800417},{"Time":"2017-03-15T00:00:00Z","Data":434.85254691689005},{"Time":"2017-03-16T00:00:00Z","Data":447.2986293653774},{"Time":"2017-03-17T00:00:00Z","Data":431.52887509888734},{"Time":"2017-03-18T00:00:00Z","Data":348.8677387594355},{"Time":"2017-03-19T00:00:00Z","Data":350.1943600953502},{"Time":"2017-03-20T00:00:00Z","Data":444.09926074331435},{"Time":"2017-03-21T00:00:00Z","Data":455.89314174403603},{"Time":"2017-03-22T00:00:00Z","Data":442.450906972874},{"Time":"2017-03-23T00:00:00Z","Data":456.1446875128744},{"Time":"2017-03-24T00:00:00Z","Data":431.393001345895},{"Time":"2017-03-25T00:00:00Z","Data":360.32822229471924},{"Time":"2017-03-26T00:00:00Z","Data":345.43821808934734},{"Time":"2017-03-27T00:00:00Z","Data":439.53924399810353},{"Time":"2017-03-28T00:00:00Z","Data":449.21310035247103},{"Time":"2017-03-29T00:00:00Z","Data":451.99337768774353},{"Time":"2017-03-30T00:00:00Z","Data":449.6744204887237},{"Time":"2017-03-31T00:00:00Z","Data":418.97906915128505},{"Time":"2017-04-01T00:00:00Z","Data":362.2255601646834},{"Time":"2017-04-02T00:00:00Z","Data":355.3352779713812},{"Time":"2017-04-03T00:00:00Z","Data":444.4040386754514},{"Time":"2017-04-04T00:00:00Z","Data":449.05588443983186},{"Time":"2017-04-05T00:00:00Z","Data":456.1162506170985},{"Time":"2017-04-06T00:00:00Z","Data":450.6904425356094},{"Time":"2017-04-07T00:00:00Z","Data":420.4648783814503},{"Time":"2017-04-08T00:00:00Z","Data":371.5817835085816},{"Time":"2017-04-09T00:00:00Z","Data":382.9273599469524},{"Time":"2017-04-10T00:00:00Z","Data":455.1107084206354},{"Time":"2017-04-11T00:00:00Z","Data":452.78115260683535},{"Time":"2017-04-12T00:00:00Z","Data":450.91072408802836},{"Time":"2017-04-13T00:00:00Z","Data":453.7676609105181},{"Time":"2017-04-14T00:00:00Z","Data":405.2940098919216},{"Time":"2017-04-15T00:00:00Z","Data":351.44560427908294},{"Time":"2017-04-16T00:00:00Z","Data":360.63513188783526},{"Time":"2017-04-17T00:00:00Z","Data":433.724741171619},{"Time":"2017-04-18T00:00:00Z","Data":456.3493816254417},{"Time":"2017-04-19T00:00:00Z","Data":458.3315585466627},{"Time":"2017-04-20T00:00:00Z","Data":463.06689748707146},{"Time":"2017-04-21T00:00:00Z","Data":424.2113167374795},{"Time":"2017-04-22T00:00:00Z","Data":368.747787731097},{"Time":"2017-04-23T00:00:00Z","Data":361.4031193882287},{"Time":"2017-04-24T00:00:00Z","Data":436.10237122225834},{"Time":"2017-04-25T00:00:00Z","Data":451.8640001958241},{"Time":"2017-04-26T00:00:00Z","Data":457.7136724416506},{"Time":"2017-04-27T00:00:00Z","Data":475.9621831835859},{"Time":"2017-04-28T00:00:00Z","Data":451.2172621070725},{"Time":"2017-04-29T00:00:00Z","Data":373.7663540370979},{"Time":"2017-04-30T00:00:00Z","Data":360.9875581609855},{"Time":"2017-05-01T00:00:00Z","Data":446.81042632692566},{"Time":"2017-05-02T00:00:00Z","Data":492.05596133901184},{"Time":"2017-05-03T00:00:00Z","Data":454.57245308753323},{"Time":"2017-05-04T00:00:00Z","Data":452.7286976346537},{"Time":"2017-05-05T00:00:00Z","Data":429.90400847781353},{"Time":"2017-05-06T00:00:00Z","Data":364.71969690019904},{"Time":"2017-05-07T00:00:00Z","Data":362.73457193539355},{"Time":"2017-05-08T00:00:00Z","Data":438.4803067270826},{"Time":"2017-05-09T00:00:00Z","Data":452.8753822793473},{"Time":"2017-05-10T00:00:00Z","Data":461.1637425776821},{"Time":"2017-05-11T00:00:00Z","Data":461.0084653657855},{"Time":"2017-05-12T00:00:00Z","Data":432.5137807332225},{"Time":"2017-05-13T00:00:00Z","Data":346.65304390742295},{"Time":"2017-05-14T00:00:00Z","Data":336.6020084112952},{"Time":"2017-05-15T00:00:00Z","Data":443.72925900354124},{"Time":"2017-05-16T00:00:00Z","Data":463.947427568418},{"Time":"2017-05-17T00:00:00Z","Data":458.79154698399674},{"Time":"2017-05-18T00:00:00Z","Data":462.8346641615782},{"Time":"2017-05-19T00:00:00Z","Data":438.5672387108911},{"Time":"2017-05-20T00:00:00Z","Data":366.19380276861096},{"Time":"2017-05-21T00:00:00Z","Data":363.8504084842949},{"Time":"2017-05-22T00:00:00Z","Data":436.16901177170894},{"Time":"2017-05-23T00:00:00Z","Data":446.60893217864356},{"Time":"2017-05-24T00:00:00Z","Data":445.59479117785077},{"Time":"2017-05-25T00:00:00Z","Data":448.257540537207},{"Time":"2017-05-26T00:00:00Z","Data":424.2331854395494},{"Time":"2017-05-27T00:00:00Z","Data":388.89591501201465},{"Time":"2017-05-28T00:00:00Z","Data":392.99434135550706},{"Time":"2017-05-29T00:00:00Z","Data":352.33470005174956},{"Time":"2017-05-30T00:00:00Z","Data":459.2390240081463},{"Time":"2017-05-31T00:00:00Z","Data":462.2442238082388},{"Time":"2017-06-01T00:00:00Z","Data":447.31888557096255},{"Time":"2017-06-02T00:00:00Z","Data":438.2386079648942},{"Time":"2017-06-03T00:00:00Z","Data":369.69399913802573},{"Time":"2017-06-04T00:00:00Z","Data":361.3457724234188},{"Time":"2017-06-05T00:00:00Z","Data":432.4343621860911},{"Time":"2017-06-06T00:00:00Z","Data":446.78106716471814},{"Time":"2017-06-07T00:00:00Z","Data":450.465315156698},{"Time":"2017-06-08T00:00:00Z","Data":458.6059218026271},{"Time":"2017-06-09T00:00:00Z","Data":434.85472384740433},{"Time":"2017-06-10T00:00:00Z","Data":376.4683214170205},{"Time":"2017-06-11T00:00:00Z","Data":366.3945490775857},{"Time":"2017-06-12T00:00:00Z","Data":443.9606889992603},{"Time":"2017-06-13T00:00:00Z","Data":442.81366731468},{"Time":"2017-06-14T00:00:00Z","Data":469.4233103818958},{"Time":"2017-06-15T00:00:00Z","Data":448.7027302017975},{"Time":"2017-06-16T00:00:00Z","Data":424.9318790266843},{"Time":"2017-06-17T00:00:00Z","Data":359.31862542142306},{"Time":"2017-06-18T00:00:00Z","Data":334.82898413822966},{"Time":"2017-06-19T00:00:00Z","Data":444.0173895860093},{"Time":"2017-06-20T00:00:00Z","Data":455.594232671384},{"Time":"2017-06-21T00:00:00Z","Data":458.04976216611783},{"Time":"2017-06-22T00:00:00Z","Data":457.7576653121537},{"Time":"2017-06-23T00:00:00Z","Data":431.2302716184093},{"Time":"2017-06-24T00:00:00Z","Data":373.526125314788},{"Time":"2017-06-25T00:00:00Z","Data":381.36320212122985},{"Time":"2017-06-26T00:00:00Z","Data":452.602956349015},{"Time":"2017-06-27T00:00:00Z","Data":459.42194333523486},{"Time":"2017-06-28T00:00:00Z","Data":465.16455740182585},{"Time":"2017-06-29T00:00:00Z","Data":461.2080269857203},{"Time":"2017-06-30T00:00:00Z","Data":427.56172933941195},{"Time":"2017-07-01T00:00:00Z","Data":364.46222640621323},{"Time":"2017-07-02T00:00:00Z","Data":365.7791032058792},{"Time":"2017-07-03T00:00:00Z","Data":397.3359743932021},{"Time":"2017-07-04T00:00:00Z","Data":347.32008717916165},{"Time":"2017-07-05T00:00:00Z","Data":448.95280534737697},{"Time":"2017-07-06T00:00:00Z","Data":453.76320996364865},{"Time":"2017-07-07T00:00:00Z","Data":434.49081621562874},{"Time":"2017-07-08T00:00:00Z","Data":371.2320343804691},{"Time":"2017-07-09T00:00:00Z","Data":362.53575848982365},{"Time":"2017-07-10T00:00:00Z","Data":446.10619322050786},{"Time":"2017-07-11T00:00:00Z","Data":458.33034526171525},{"Time":"2017-07-12T00:00:00Z","Data":454.3611807923206},{"Time":"2017-07-13T00:00:00Z","Data":459.25783650891213},{"Time":"2017-07-14T00:00:00Z","Data":434.59324087054756},{"Time":"2017-07-15T00:00:00Z","Data":375.6845198343796},{"Time":"2017-07-16T00:00:00Z","Data":371.1124449147857},{"Time":"2017-07-17T00:00:00Z","Data":451.1391954432182},{"Time":"2017-07-18T00:00:00Z","Data":454.69534107553045},{"Time":"2017-07-19T00:00:00Z","Data":463.8036426658756},{"Time":"2017-07-20T00:00:00Z","Data":476.57405008306534},{"Time":"2017-07-21T00:00:00Z","Data":441.51095478859827},{"Time":"2017-07-22T00:00:00Z","Data":368.2701947976061},{"Time":"2017-07-23T00:00:00Z","Data":370.02102392181376},{"Time":"2017-07-24T00:00:00Z","Data":441.11170456994535},{"Time":"2017-07-25T00:00:00Z","Data":461.7726948938935},{"Time":"2017-07-26T00:00:00Z","Data":460.0247808728374},{"Time":"2017-07-27T00:00:00Z","Data":460.29409171853234},{"Time":"2017-07-28T00:00:00Z","Data":437.73124382542665},{"Time":"2017-07-29T00:00:00Z","Data":376.3054436699549},{"Time":"2017-07-30T00:00:00Z","Data":366.5657785603073},{"Time":"2017-07-31T00:00:00Z","Data":451.3778494443726},{"Time":"2017-08-01T00:00:00Z","Data":459.9704267004647},{"Time":"2017-08-02T00:00:00Z","Data":448.3358553184646},{"Time":"2017-08-03T00:00:00Z","Data":459.35535194657473},{"Time":"2017-08-04T00:00:00Z","Data":426.94736576471996},{"Time":"2017-08-05T00:00:00Z","Data":361.26943956435036},{"Time":"2017-08-06T00:00:00Z","Data":352.9152491012521},{"Time":"2017-08-07T00:00:00Z","Data":438.13825295926335},{"Time":"2017-08-08T00:00:00Z","Data":453.5287706902479},{"Time":"2017-08-09T00:00:00Z","Data":454.7870602330901},{"Time":"2017-08-10T00:00:00Z","Data":460.30943256450075},{"Time":"2017-08-11T00:00:00Z","Data":429.0216858997702},{"Time":"2017-08-12T00:00:00Z","Data":360.1488448077327},{"Time":"2017-08-13T00:00:00Z","Data":352.68873587326993},{"Time":"2017-08-14T00:00:00Z","Data":441.8381930426839},{"Time":"2017-08-15T00:00:00Z","Data":447.56707594361075},{"Time":"2017-08-16T00:00:00Z","Data":449.1295938104449},{"Time":"2017-08-17T00:00:00Z","Data":449.9644349604339},{"Time":"2017-08-18T00:00:00Z","Data":424.4285583595802},{"Time":"2017-08-19T00:00:00Z","Data":361.06187442597826},{"Time":"2017-08-20T00:00:00Z","Data":349.2558958599496},{"Time":"2017-08-21T00:00:00Z","Data":450.80500894454383},{"Time":"2017-08-22T00:00:00Z","Data":449.55222570165944},{"Time":"2017-08-23T00:00:00Z","Data":457.67710729664367},{"Time":"2017-08-24T00:00:00Z","Data":463.5919288131345},{"Time":"2017-08-25T00:00:00Z","Data":436.0202258828458},{"Time":"2017-08-26T00:00:00Z","Data":372.9785020192935},{"Time":"2017-08-27T00:00:00Z","Data":363.2200917194251},{"Time":"2017-08-28T00:00:00Z","Data":444.5522445522446},{"Time":"2017-08-29T00:00:00Z","Data":453.493116527889},{"Time":"2017-08-30T00:00:00Z","Data":464.2545931181946},{"Time":"2017-08-31T00:00:00Z","Data":479.24936065987106},{"Time":"2017-09-01T00:00:00Z","Data":422.1989277905897},{"Time":"2017-09-02T00:00:00Z","Data":354.3980770075076},{"Time":"2017-09-03T00:00:00Z","Data":346.4710862537842},{"Time":"2017-09-04T00:00:00Z","Data":335.0285991797971},{"Time":"2017-09-05T00:00:00Z","Data":448.37255501222495},{"Time":"2017-09-06T00:00:00Z","Data":452.69771436320076},{"Time":"2017-09-07T00:00:00Z","Data":456.83019704979847},{"Time":"2017-09-08T00:00:00Z","Data":440.61175806857136},{"Time":"2017-09-09T00:00:00Z","Data":387.40934685918364},{"Time":"2017-09-10T00:00:00Z","Data":364.49180532186705},{"Time":"2017-09-11T00:00:00Z","Data":454.0033676795452},{"Time":"2017-09-12T00:00:00Z","Data":458.48964528624145},{"Time":"2017-09-13T00:00:00Z","Data":457.13386817681294},{"Time":"2017-09-14T00:00:00Z","Data":459.6192991142653},{"Time":"2017-09-15T00:00:00Z","Data":435.72166294022173},{"Time":"2017-09-16T00:00:00Z","Data":375.8655583281678},{"Time":"2017-09-17T00:00:00Z","Data":357.62223672635434},{"Time":"2017-09-18T00:00:00Z","Data":447.72733320914386},{"Time":"2017-09-19T00:00:00Z","Data":455.25882714975717},{"Time":"2017-09-20T00:00:00Z","Data":462.5211726384365},{"Time":"2017-09-21T00:00:00Z","Data":464.7870456164237},{"Time":"2017-09-22T00:00:00Z","Data":444.409846101881},{"Time":"2017-09-23T00:00:00Z","Data":380.6939814213486},{"Time":"2017-09-24T00:00:00Z","Data":364.35098693438545},{"Time":"2017-09-25T00:00:00Z","Data":449.0059648908024},{"Time":"2017-09-26T00:00:00Z","Data":461.08896509183046},{"Time":"2017-09-27T00:00:00Z","Data":462.620761200804},{"Time":"2017-09-28T00:00:00Z","Data":462.82881182459823},{"Time":"2017-09-29T00:00:00Z","Data":435.29111444527797},{"Time":"2017-09-30T00:00:00Z","Data":373.1960607883394},{"Time":"2017-10-01T00:00:00Z","Data":360.3248127180191},{"Time":"2017-10-02T00:00:00Z","Data":447.32423501598475},{"Time":"2017-10-03T00:00:00Z","Data":462.13056989429066},{"Time":"2017-10-04T00:00:00Z","Data":459.3843660359399},{"Time":"2017-10-05T00:00:00Z","Data":469.4144138540202},{"Time":"2017-10-06T00:00:00Z","Data":446.32025719398825},{"Time":"2017-10-07T00:00:00Z","Data":383.60839052980646},{"Time":"2017-10-08T00:00:00Z","Data":364.03348686306884},{"Time":"2017-10-09T00:00:00Z","Data":421.1436594549748},{"Time":"2017-10-10T00:00:00Z","Data":459.0434048886143},{"Time":"2017-10-11T00:00:00Z","Data":463.97734021654713},{"Time":"2017-10-12T00:00:00Z","Data":464.4409711895617},{"Time":"2017-10-13T00:00:00Z","Data":448.1285448212726},{"Time":"2017-10-14T00:00:00Z","Data":383.6776829603616},{"Time":"2017-10-15T00:00:00Z","Data":362.493381184915},{"Time":"2017-10-16T00:00:00Z","Data":441.6028018403723},{"Time":"2017-10-17T00:00:00Z","Data":456.69960120236493},{"Time":"2017-10-18T00:00:00Z","Data":465.14700151261945},{"Time":"2017-10-19T00:00:00Z","Data":472.2261868352193},{"Time":"2017-10-20T00:00:00Z","Data":452.1748675869261},{"Time":"2017-10-21T00:00:00Z","Data":395.4046538855554},{"Time":"2017-10-22T00:00:00Z","Data":368.57072131088154},{"Time":"2017-10-23T00:00:00Z","Data":455.1078009167759},{"Time":"2017-10-24T00:00:00Z","Data":461.1204949225666},{"Time":"2017-10-25T00:00:00Z","Data":471.585885901503},{"Time":"2017-10-26T00:00:00Z","Data":473.368189393072},{"Time":"2017-10-27T00:00:00Z","Data":447.6515676963844},{"Time":"2017-10-28T00:00:00Z","Data":384.9851301742215},{"Time":"2017-10-29T00:00:00Z","Data":367.4746514575412},{"Time":"2017-10-30T00:00:00Z","Data":447.44934042618615},{"Time":"2017-10-31T00:00:00Z","Data":524.8871194093599},{"Time":"2017-11-01T00:00:00Z","Data":471.21240609186856},{"Time":"2017-11-02T00:00:00Z","Data":479.299282336498},{"Time":"2017-11-03T00:00:00Z","Data":452.8270650907865},{"Time":"2017-11-04T00:00:00Z","Data":380.97209016164214},{"Time":"2017-11-05T00:00:00Z","Data":367.998274839614},{"Time":"2017-11-06T00:00:00Z","Data":459.67018396335027},{"Time":"2017-11-07T00:00:00Z","Data":473.3275117269306},{"Time":"2017-11-08T00:00:00Z","Data":469.8363622652892},{"Time":"2017-11-09T00:00:00Z","Data":474.2806450228219},{"Time":"2017-11-10T00:00:00Z","Data":429.88668154972163},{"Time":"2017-11-11T00:00:00Z","Data":362.8524196881269},{"Time":"2017-11-12T00:00:00Z","Data":365.6948578570037},{"Time":"2017-11-13T00:00:00Z","Data":455.86895034569454},{"Time":"2017-11-14T00:00:00Z","Data":471.3126074146821},{"Time":"2017-11-15T00:00:00Z","Data":475.6708421427543},{"Time":"2017-11-16T00:00:00Z","Data":468.7765945212411},{"Time":"2017-11-17T00:00:00Z","Data":442.1068092356501},{"Time":"2017-11-18T00:00:00Z","Data":373.0927771625446},{"Time":"2017-11-19T00:00:00Z","Data":352.1326119778561},{"Time":"2017-11-20T00:00:00Z","Data":424.36023555729247},{"Time":"2017-11-21T00:00:00Z","Data":415.43052751689635},{"Time":"2017-11-22T00:00:00Z","Data":372.13675401651693},{"Time":"2017-11-23T00:00:00Z","Data":144.23131652342195},{"Time":"2017-11-24T00:00:00Z","Data":255.99263974537496},{"Time":"2017-11-25T00:00:00Z","Data":332.1033405685849},{"Time":"2017-11-26T00:00:00Z","Data":342.50933739106375},{"Time":"2017-11-27T00:00:00Z","Data":404.3639483078286},{"Time":"2017-11-28T00:00:00Z","Data":450.3308818110805},{"Time":"2017-11-29T00:00:00Z","Data":462.27512042928436},{"Time":"2017-11-30T00:00:00Z","Data":468.2177711455334},{"Time":"2017-12-01T00:00:00Z","Data":444.8490477350081},{"Time":"2017-12-02T00:00:00Z","Data":380.5965732548161},{"Time":"2017-12-03T00:00:00Z","Data":366.8976356344994},{"Time":"2017-12-04T00:00:00Z","Data":443.5051696519586},{"Time":"2017-12-05T00:00:00Z","Data":458.3516838427435},{"Time":"2017-12-06T00:00:00Z","Data":460.6896072780305},{"Time":"2017-12-07T00:00:00Z","Data":455.77065399446894},{"Time":"2017-12-08T00:00:00Z","Data":427.81333829114766},{"Time":"2017-12-09T00:00:00Z","Data":354.5558448456566},{"Time":"2017-12-10T00:00:00Z","Data":343.01970789768865},{"Time":"2017-12-11T00:00:00Z","Data":421.8410550872666},{"Time":"2017-12-12T00:00:00Z","Data":434.694204077279}],"Meta":{"VendorCode":"Number of Visits","Label":"Number of Visits","Units":"#","Source":"PlaceIQ","Upsample":4,"Downsample":3,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2016-10-01T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Chipotle","UniqueId":"Chipotle","IsCustom":true}}],"Title":"Chipotle → Number of Visits All Available","Error":"","GraphicalPreference":""}
`

var bogusData2 = `{"EntityData":[{"Data":[{"Data":[{"Time":"2017-08-07T00:00:00Z","Data":64},{"Time":"2017-08-08T00:00:00Z","Data":65},{"Time":"2017-08-09T00:00:00Z","Data":50},{"Time":"2017-08-10T00:00:00Z","Data":56},{"Time":"2017-08-11T00:00:00Z","Data":63},{"Time":"2017-08-12T00:00:00Z","Data":72},{"Time":"2017-08-13T00:00:00Z","Data":51},{"Time":"2017-08-14T00:00:00Z","Data":41},{"Time":"2017-08-15T00:00:00Z","Data":35},{"Time":"2017-08-16T00:00:00Z","Data":41},{"Time":"2017-08-17T00:00:00Z","Data":57},{"Time":"2017-08-18T00:00:00Z","Data":44},{"Time":"2017-08-19T00:00:00Z","Data":54},{"Time":"2017-08-20T00:00:00Z","Data":62},{"Time":"2017-08-21T00:00:00Z","Data":41},{"Time":"2017-08-22T00:00:00Z","Data":44},{"Time":"2017-08-23T00:00:00Z","Data":39},{"Time":"2017-08-24T00:00:00Z","Data":39},{"Time":"2017-08-25T00:00:00Z","Data":49},{"Time":"2017-08-26T00:00:00Z","Data":61},{"Time":"2017-08-27T00:00:00Z","Data":74},{"Time":"2017-08-28T00:00:00Z","Data":40},{"Time":"2017-08-29T00:00:00Z","Data":42},{"Time":"2017-08-30T00:00:00Z","Data":56},{"Time":"2017-08-31T00:00:00Z","Data":59},{"Time":"2017-09-01T00:00:00Z","Data":62},{"Time":"2017-09-02T00:00:00Z","Data":81},{"Time":"2017-09-03T00:00:00Z","Data":73},{"Time":"2017-09-04T00:00:00Z","Data":72},{"Time":"2017-09-05T00:00:00Z","Data":62},{"Time":"2017-09-06T00:00:00Z","Data":59},{"Time":"2017-09-07T00:00:00Z","Data":46},{"Time":"2017-09-08T00:00:00Z","Data":57},{"Time":"2017-09-09T00:00:00Z","Data":77},{"Time":"2017-09-10T00:00:00Z","Data":88},{"Time":"2017-09-11T00:00:00Z","Data":56},{"Time":"2017-09-12T00:00:00Z","Data":58},{"Time":"2017-09-13T00:00:00Z","Data":65},{"Time":"2017-09-14T00:00:00Z","Data":52},{"Time":"2017-09-15T00:00:00Z","Data":68},{"Time":"2017-09-16T00:00:00Z","Data":74},{"Time":"2017-09-17T00:00:00Z","Data":75},{"Time":"2017-09-18T00:00:00Z","Data":45},{"Time":"2017-09-19T00:00:00Z","Data":69},{"Time":"2017-09-20T00:00:00Z","Data":52},{"Time":"2017-09-21T00:00:00Z","Data":84},{"Time":"2017-09-22T00:00:00Z","Data":121},{"Time":"2017-09-23T00:00:00Z","Data":142},{"Time":"2017-09-24T00:00:00Z","Data":195},{"Time":"2017-09-25T00:00:00Z","Data":121},{"Time":"2017-09-26T00:00:00Z","Data":95},{"Time":"2017-09-27T00:00:00Z","Data":97},{"Time":"2017-09-28T00:00:00Z","Data":86},{"Time":"2017-09-29T00:00:00Z","Data":92},{"Time":"2017-09-30T00:00:00Z","Data":93},{"Time":"2017-10-01T00:00:00Z","Data":114},{"Time":"2017-10-02T00:00:00Z","Data":87},{"Time":"2017-10-03T00:00:00Z","Data":77},{"Time":"2017-10-04T00:00:00Z","Data":63},{"Time":"2017-10-05T00:00:00Z","Data":76},{"Time":"2017-10-06T00:00:00Z","Data":75},{"Time":"2017-10-07T00:00:00Z","Data":98},{"Time":"2017-10-08T00:00:00Z","Data":94},{"Time":"2017-10-09T00:00:00Z","Data":81},{"Time":"2017-10-10T00:00:00Z","Data":85},{"Time":"2017-10-11T00:00:00Z","Data":66},{"Time":"2017-10-12T00:00:00Z","Data":91},{"Time":"2017-10-13T00:00:00Z","Data":97},{"Time":"2017-10-14T00:00:00Z","Data":111},{"Time":"2017-10-15T00:00:00Z","Data":121},{"Time":"2017-10-16T00:00:00Z","Data":100},{"Time":"2017-10-17T00:00:00Z","Data":65},{"Time":"2017-10-18T00:00:00Z","Data":74},{"Time":"2017-10-19T00:00:00Z","Data":69},{"Time":"2017-10-20T00:00:00Z","Data":47},{"Time":"2017-10-21T00:00:00Z","Data":79},{"Time":"2017-10-22T00:00:00Z","Data":111},{"Time":"2017-10-23T00:00:00Z","Data":71},{"Time":"2017-10-24T00:00:00Z","Data":69},{"Time":"2017-10-25T00:00:00Z","Data":53},{"Time":"2017-10-26T00:00:00Z","Data":44},{"Time":"2017-10-27T00:00:00Z","Data":60},{"Time":"2017-10-28T00:00:00Z","Data":68},{"Time":"2017-10-29T00:00:00Z","Data":42},{"Time":"2017-10-30T00:00:00Z","Data":8}],"Meta":{"VendorCode":"Number of Visits","Label":"Number of Visits","Units":"#","Source":"Narrative","Upsample":4,"Downsample":3,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-08-07T00:00:00Z","Data":6},{"Time":"2017-08-08T00:00:00Z","Data":10},{"Time":"2017-08-09T00:00:00Z","Data":8},{"Time":"2017-08-10T00:00:00Z","Data":10},{"Time":"2017-08-11T00:00:00Z","Data":10},{"Time":"2017-08-12T00:00:00Z","Data":10},{"Time":"2017-08-13T00:00:00Z","Data":9},{"Time":"2017-08-14T00:00:00Z","Data":9},{"Time":"2017-08-15T00:00:00Z","Data":8},{"Time":"2017-08-16T00:00:00Z","Data":8},{"Time":"2017-08-17T00:00:00Z","Data":8},{"Time":"2017-08-18T00:00:00Z","Data":10},{"Time":"2017-08-19T00:00:00Z","Data":9},{"Time":"2017-08-20T00:00:00Z","Data":9},{"Time":"2017-08-21T00:00:00Z","Data":9},{"Time":"2017-08-22T00:00:00Z","Data":8},{"Time":"2017-08-23T00:00:00Z","Data":10},{"Time":"2017-08-24T00:00:00Z","Data":8},{"Time":"2017-08-25T00:00:00Z","Data":10},{"Time":"2017-08-26T00:00:00Z","Data":9},{"Time":"2017-08-27T00:00:00Z","Data":8},{"Time":"2017-08-28T00:00:00Z","Data":8},{"Time":"2017-08-29T00:00:00Z","Data":9},{"Time":"2017-08-30T00:00:00Z","Data":10},{"Time":"2017-08-31T00:00:00Z","Data":9},{"Time":"2017-09-01T00:00:00Z","Data":9},{"Time":"2017-09-02T00:00:00Z","Data":9},{"Time":"2017-09-03T00:00:00Z","Data":8},{"Time":"2017-09-04T00:00:00Z","Data":7},{"Time":"2017-09-05T00:00:00Z","Data":8},{"Time":"2017-09-06T00:00:00Z","Data":9},{"Time":"2017-09-07T00:00:00Z","Data":9},{"Time":"2017-09-08T00:00:00Z","Data":8},{"Time":"2017-09-09T00:00:00Z","Data":9},{"Time":"2017-09-10T00:00:00Z","Data":10},{"Time":"2017-09-11T00:00:00Z","Data":8},{"Time":"2017-09-12T00:00:00Z","Data":9},{"Time":"2017-09-13T00:00:00Z","Data":9},{"Time":"2017-09-14T00:00:00Z","Data":9},{"Time":"2017-09-15T00:00:00Z","Data":8},{"Time":"2017-09-16T00:00:00Z","Data":10},{"Time":"2017-09-17T00:00:00Z","Data":9},{"Time":"2017-09-18T00:00:00Z","Data":8},{"Time":"2017-09-19T00:00:00Z","Data":10},{"Time":"2017-09-20T00:00:00Z","Data":7},{"Time":"2017-09-21T00:00:00Z","Data":9},{"Time":"2017-09-22T00:00:00Z","Data":8},{"Time":"2017-09-23T00:00:00Z","Data":9},{"Time":"2017-09-24T00:00:00Z","Data":9},{"Time":"2017-09-25T00:00:00Z","Data":9},{"Time":"2017-09-26T00:00:00Z","Data":10},{"Time":"2017-09-27T00:00:00Z","Data":8},{"Time":"2017-09-28T00:00:00Z","Data":10},{"Time":"2017-09-29T00:00:00Z","Data":8},{"Time":"2017-09-30T00:00:00Z","Data":9},{"Time":"2017-10-01T00:00:00Z","Data":10},{"Time":"2017-10-02T00:00:00Z","Data":10},{"Time":"2017-10-03T00:00:00Z","Data":10},{"Time":"2017-10-04T00:00:00Z","Data":9},{"Time":"2017-10-05T00:00:00Z","Data":10},{"Time":"2017-10-06T00:00:00Z","Data":9},{"Time":"2017-10-07T00:00:00Z","Data":9},{"Time":"2017-10-08T00:00:00Z","Data":9},{"Time":"2017-10-09T00:00:00Z","Data":10},{"Time":"2017-10-10T00:00:00Z","Data":10},{"Time":"2017-10-11T00:00:00Z","Data":9},{"Time":"2017-10-12T00:00:00Z","Data":10},{"Time":"2017-10-13T00:00:00Z","Data":10},{"Time":"2017-10-14T00:00:00Z","Data":9},{"Time":"2017-10-15T00:00:00Z","Data":9},{"Time":"2017-10-16T00:00:00Z","Data":10},{"Time":"2017-10-17T00:00:00Z","Data":10},{"Time":"2017-10-18T00:00:00Z","Data":9},{"Time":"2017-10-19T00:00:00Z","Data":9},{"Time":"2017-10-20T00:00:00Z","Data":8},{"Time":"2017-10-21T00:00:00Z","Data":10},{"Time":"2017-10-22T00:00:00Z","Data":10},{"Time":"2017-10-23T00:00:00Z","Data":10},{"Time":"2017-10-24T00:00:00Z","Data":10},{"Time":"2017-10-25T00:00:00Z","Data":9},{"Time":"2017-10-26T00:00:00Z","Data":9},{"Time":"2017-10-27T00:00:00Z","Data":7},{"Time":"2017-10-28T00:00:00Z","Data":10},{"Time":"2017-10-29T00:00:00Z","Data":8},{"Time":"2017-10-30T00:00:00Z","Data":6}],"Meta":{"VendorCode":"Number of Stores","Label":"Number of Stores","Units":"#","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-08-07T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Whole Foods","UniqueId":"Whole Foods","IsCustom":true}}],"Title":"Whole Foods Market, Inc. â†’ Traffic per Store Last Five Years","Error":"","GraphicalPreference":""}`

var bogusData3 = `{"EntityData":[{"Data":[{"Data":[{"Time":"2017-10-29T00:00:00Z","Data":0.034763805}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-29T00:00:00Z","Data":-0.5}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-29T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"4800 El Camino WF","UniqueId":"4800 El Camino WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":0.088822355}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":-0.8333333333333334}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"777 WF","UniqueId":"777 WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":0.178310046}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":-0.9285714285714286}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Augustine","UniqueId":"Augustine","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":0.13023952}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":-0.8}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Blossom WF","UniqueId":"Blossom WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":0.037258815}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":-0.6666666666666667}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Boscom WF","UniqueId":"Boscom WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-29T00:00:00Z","Data":0.130572188}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-29T00:00:00Z","Data":0.16666666666666674}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-29T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Emerson","UniqueId":"Emerson","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-28T00:00:00Z","Data":0.087990685}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-28T00:00:00Z","Data":-0.1428571428571429}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-28T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"jefferson WF","UniqueId":"jefferson WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-28T00:00:00Z","Data":0.017465069}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-28T00:00:00Z","Data":0}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-28T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Los Gatos WF","UniqueId":"Los Gatos WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":0.217897538}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":-0.8823529411764706}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Park WF","UniqueId":"Park WF","IsCustom":true}},{"Data":[{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":0.076679973}],"Meta":{"VendorCode":"% of Traffic","Label":"% of Traffic","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false},{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":-0.33333333333333337}],"Meta":{"VendorCode":"WoW Change","Label":"WoW Change","Units":"%","Source":"Narrative","Upsample":1,"Downsample":1,"IsTransformed":false},"IsWeight":false}],"Category":{"Data":[{"Time":"2017-10-30T00:00:00Z","Data":1}],"Labels":[{"Id":1,"Label":""}]},"Meta":{"Name":"Stephens Cr. WF","UniqueId":"Stephens Cr. WF","IsCustom":true}}],"Title":"Whole Foods Market, Inc. → Traffic Contribution Last Five Years","Error":"","GraphicalPreference":""}`

var sqlDb *sql.DB

func connect() (*sql.DB, error) {
	var db *sql.DB

	connectionName := os.Getenv("CLOUDSQL_CONNECTION_NAME")
	user := os.Getenv("CLOUDSQL_USER")
	password := os.Getenv("CLOUDSQL_PASSWORD") // NOTE: password may be empty

	var err error
	db, err = sql.Open("mysql", fmt.Sprintf("%s:%s@cloudsql(%s)/location", user, password, connectionName))
	if err != nil {
		return nil, err
	}

	// rows, err := db.Query("SHOW DATABASES")
	// if err != nil {
	// 	return nil, err
	// }
	// defer rows.Close()

	return db, nil
}

func QueryStringArray(ctx context.Context, query string, args ...interface{}) []string {
	var err error
	if sqlDb == nil {
		sqlDb, err = connect()
	}
	if err != nil {
		log.Errorf(ctx, "Unable to connect to database")
	}

	sArr := make([]string, 0)
	rows, err := sqlDb.Query(query, args...)

	if err != nil {
		log.Errorf(ctx, "query error = %s", err)
		return sArr
	}

	var s string

	defer rows.Close()
	for rows.Next() {
		err := rows.Scan(&s)

		if err != nil {
			log.Errorf(ctx, "query error = %s", err)
		} else {
			sArr = append(sArr, s)
		}
	}

	return sArr
}

func GenericQuery(ctx context.Context, query string, metaMap map[string]SeriesMeta, stringJoiner string) MultiEntityData {
	var err error
	if sqlDb == nil {
		sqlDb, err = connect()
	}
	if err != nil {
		log.Errorf(ctx, "Unable to connect to database")
	}

	var m MultiEntityData

	rows, err := sqlDb.Query(query)

	if err != nil {
		log.Errorf(ctx, "query error = %s", err)
		return m
	}

	m.Title = ""
	var date, entity, field, subfield string
	var data float64

	defer rows.Close()
	for rows.Next() {
		err := rows.Scan(&date, &entity, &field, &subfield, &data)

		if err != nil {
			log.Errorf(ctx, "query error = %s", err)
		} else {
			t, _ := time.Parse("2006-01-02", date)

			seriesMeta := metaMap[field]

			if subfield != "" {
				seriesMeta.VendorCode = seriesMeta.VendorCode + stringJoiner + subfield
				seriesMeta.Label = seriesMeta.VendorCode
			}

			m = m.Insert(
				EntityMeta{
					Name:     entity,
					UniqueId: entity,
					IsCustom: true,
				},
				seriesMeta,
				DataPoint{
					Time: t,
					Data: data,
				},
				CategoryLabel{
					Id:    0,
					Label: "",
				},
				false)
		}
	}

	return m
}

func listOfStringsToQuotedCommaList(entities []string) string {
	for i, v := range entities {
		entities[i] = "'" + strings.Replace(v, "'", "\\'", -1) + "'"
	}

	return strings.Join(entities, ", ")
}

func GetSQLData(ctx context.Context, entities []string, queryName string, parameters map[string][]string, startDate time.Time, endDate time.Time) MultiEntityData {
	timer := time.Now()

	metaMap := map[string]SeriesMeta{
		"Number of Visits": SeriesMeta{
			VendorCode:    "Number of Visits",
			Label:         "Number of Visits",
			Units:         "#",
			Source:        "PlaceIQ",
			Upsample:      ResampleZero,
			Downsample:    ResampleArithmetic,
			IsTransformed: false,
		},
		"% of Traffic": SeriesMeta{
			VendorCode:    "% of Traffic",
			Label:         "% of Traffic",
			Units:         "%",
			Source:        "PlaceIQ",
			Upsample:      ResampleLastValue,
			Downsample:    ResampleLastValue,
			IsTransformed: false,
		},
		"SSS Estimate": SeriesMeta{
			VendorCode:    "Same-Store Sales Street Est.",
			Label:         "Same-Store Sales Street Est.",
			Units:         "%",
			Source:        "Third-Party",
			Upsample:      ResampleLastValue,
			Downsample:    ResampleLastValue,
			IsTransformed: false,
		},
		"WoW Change": SeriesMeta{
			VendorCode:    "WoW Change",
			Label:         "WoW Change",
			Units:         "%",
			Source:        "Narrative",
			Upsample:      ResampleLastValue,
			Downsample:    ResampleLastValue,
			IsTransformed: false,
		},
	}

	var dateRestriction string
	if !startDate.IsZero() {
		dateRestriction = " and local_date >= '" + startDate.String() + "' "
	} else {
		dateRestriction = ""
	}

	var dmaRestriction string
	var dmaList []string
	var normalization string = "raw"
	var movementSource string = "both"
	var dataTable string = "location.with_store_count"
	if parameters != nil {
		dmaList = parameters["DMA"]
		if len(dmaList) > 0 {
			dmaRestriction = " and dma in (" + listOfStringsToQuotedCommaList(dmaList) + ")"
		} else {
			dmaRestriction = ""
		}

		source := parameters["Movement Source"]
		if len(source) > 0 {
			switch source[0] {
			case "Foreground":
				movementSource = "foreground"
			case "Background":
				movementSource = "background"
			default:
				movementSource = "both"
			}
		}

		confidence := parameters["Confidence Score"]
		if len(confidence) > 0 {
			switch confidence[0] {
			case "zero":
				dataTable = "location.with_store_count"
			case "zero_point_two":
				dataTable = "location.with_02_filter"
			default:
				dataTable = "location.with_store_count"
			}
		}

		norm := parameters["Normalization"]
		if len(norm) > 0 {
			switch norm[0] {
			case "raw":
				normalization = "raw"
			case "placeiq":
				if movementSource == "foreground" {
					normalization = "placeiq_fg"
				} else if movementSource == "background" {
					normalization = "placeiq_bg"
				} else {
					normalization = "placeiq_all"
				}
			case "alphahat_raw":
				if movementSource == "foreground" {
					normalization = "ah_fg*1000"
				} else if movementSource == "background" {
					normalization = "ah_bg*1000"
				} else {
					normalization = "ah_all*1000"
				}
			case "alphahat_smoothed":
				if movementSource == "foreground" {
					normalization = "smoothed_fg*1000"
				} else if movementSource == "background" {
					normalization = "smoothed_bg*1000"
				} else {
					normalization = "smoothed_all*1000"
				}
			default:
				normalization = "raw"
			}
		}
	}

	var movementSourceQuery string
	if movementSource == "foreground" {
		movementSourceQuery = `where movement_source = 'foreground'`
	} else if movementSource == "background" {
		movementSourceQuery = `where movement_source = 'background'`
	} else {
		movementSourceQuery = `where movement_source in ('background', 'foreground')`
	}

	var query string
	switch queryName {
	case "Number of Visits":
		if len(dmaList) > 0 {
			query = `SELECT date_format(local_date, '%Y-%m-%d') as date, brand, "Number of Visits" as field, dma as subfield, sum(visit_count) as visit_count FROM ` + dataTable + `
			` + movementSourceQuery + `
			and brand in (` + listOfStringsToQuotedCommaList(entities) + `) ` + dateRestriction + dmaRestriction + `
			group by local_date, brand, dma`
		} else {
			query = `SELECT date_format(local_date, '%Y-%m-%d') as date, brand, "Number of Visits" as field, "" as subfield, sum(visit_count) as visit_count FROM ` + dataTable + `
			` + movementSourceQuery + `
			and brand in (` + listOfStringsToQuotedCommaList(entities) + `) ` + dateRestriction + dmaRestriction + `
			group by local_date, brand`
		}

		query = `SELECT a.date, a.brand, a.field, a.subfield, a.visit_count / b.` + normalization + ` as normalized_visit_count FROM ( ` +
			query +
			`) a JOIN location.factors b on a.date = b.date `

	case "Traffic By DMA":
		query = `SELECT date_format(local_date, '%Y-%m-%d') as date, brand, "Number of Visits" as field, dma as subfield, sum(visit_count) as visit_count FROM ` + dataTable + `
		` + movementSourceQuery + `
		and brand in (` + listOfStringsToQuotedCommaList(entities) + `) ` + dateRestriction + `
		group by local_date, brand, dma`

		query = `SELECT a.date, a.subfield as brand, a.field, '' as subfield, a.visit_count / b.` + normalization + ` as normalized_visit_count FROM ( ` +
			query +
			`) a JOIN location.factors b on a.date = b.date `

	case "Traffic Contribution":
		dateRestriction = ` and local_date = (select max(local_date) from ` + dataTable + `) `

		entityList := listOfStringsToQuotedCommaList(entities)

		query1 := `SELECT date_format(local_date, '%Y-%m-%d') as date, brand, "Number of Visits" as field, dma as subfield, sum(visit_count) as visit_count FROM ` + dataTable + `
		` + movementSourceQuery + `
		and brand in (` + entityList + `) ` + dateRestriction + `
		group by local_date, brand, dma`

		query2 := `SELECT date_format(local_date, '%Y-%m-%d') as date, brand, "Number of Visits" as field, '' as subfield, sum(visit_count) as visit_count FROM ` + dataTable + `
		` + movementSourceQuery + `
		and brand in (` + entityList + `) ` + dateRestriction + `
		group by local_date, brand`

		query = `SELECT a.date, a.subfield as brand, '% of Traffic' as field, '' as subfield, a.visit_count / b.visit_count as value
			FROM (` +
			query1 +
			`) a LEFT JOIN
			(` +
			query2 +
			`) b ON a.brand = b.brand `

	case "SSS Estimate":
		query = `SELECT date_format(date, '%Y-%m-%d') as date, brand, 'SSS Estimate' as field, '' as subfield, sss FROM location.sss
		where brand in (` + listOfStringsToQuotedCommaList(entities) + `) ` + dateRestriction
	}

	log.Infof(ctx, "running query = %s", query)

	if appengine.IsDevAppServer() {
		time.Sleep(time.Second * 1)
		var m MultiEntityData
		log.Infof(ctx, "CANNOT DO A SQL CONNECT ON THE DEV SERVER")
		switch queryName {
		case "Number of Visits":
			json.Unmarshal([]byte(bogusData), &m)
		case "Traffic By DMA":
			json.Unmarshal([]byte(bogusData), &m)
		case "Traffic Contribution":
			json.Unmarshal([]byte(bogusData), &m)
		case "SSS Estimate":
			json.Unmarshal([]byte(bogusData), &m)
		}
		return m
	}

	temp := GenericQuery(ctx, query, metaMap, " in ")
	log.Infof(ctx, "time taken was %v\nentities = %s\nqueryName = %s\nparameters = %s\nstartDate = %s\nendDate = %s", time.Since(timer), entities, queryName, parameters, startDate, endDate)

	return temp
}

func GetVisitCounts(ctx context.Context) MultiEntityData {
	return GenericQuery(ctx, `select date, brand, "Number of Visits" as field, sum(num_visit)
from wow_change
group by date, brand`,
		map[string]SeriesMeta{
			"Number of Visits": SeriesMeta{
				VendorCode:    "Number of Visits",
				Label:         "Number of Visits",
				Units:         "#",
				Source:        "Narrative",
				Upsample:      ResampleZero,
				Downsample:    ResampleArithmetic,
				IsTransformed: false,
			},
		}, "")

}
